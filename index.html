<!DOCTYPE html>
<html>
<head lang="zh" title="winkvm">
    <meta charset="utf-8">
    <meta name="description" content="WebRTC code samples">
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
</head>
<style>
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: black;
    }

    /* å·¥å…·æ æ ·å¼ */
    .floating-toolbar {
        position: fixed;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        background-color: #333;
        color: white;
        padding: 10px;
        border-radius: 0 5px 5px 0;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        transition: transform 0.3s, opacity 0.3s;
    }

    /* éšè—çš„æ ·å¼ */
    .floating-toolbar.hidden {
        transform: translate(-90%, -50%);
    }

    /* æŒ‰é’®æ ·å¼ */
    .floating-toolbar button {
        display: block;
        width: 40px;
        height: 40px;
        margin: 5px 0;
        border: none;
        background-color: #555;
        color: white;
        font-size: 16px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .floating-toolbar button:hover {
        background-color: #777;
    }

    /* å·¥å…·æç¤ºæ–‡å­— */
    .tooltip {
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        background-color: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    .floating-toolbar button:hover .tooltip {
        opacity: 1;
    }

    /* æ˜¾ç¤º/éšè—ç®­å¤´æŒ‰é’®æ ·å¼ */
    .toggle-button {
        width: 30px;
        height: 30px;
        margin: 5px 0;
        border: none;
        background-color: #555;
        color: white;
        font-size: 10px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .toggle-button:hover {
        background-color: #777;
    }

    /* éšè—çŠ¶æ€æ—¶ç®­å¤´æŒ‰é’®æ ·å¼ */
    .floating-toolbar.hidden .toggle-button {
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        background-color: #333;
        width: 10px;
        height: 20px;
        font-size: 8px;
        border-radius: 5px 0 0 5px;
    }
</style>

<body>
<div id="container" style="width: 100%;height: 100%">
    <video id="video" playsinline autoplay style="width: 100%;height:100%;cursor: none"></video>
    <button id="authSerial" style="display: none"></button>
</div>
<div class="floating-toolbar">
    <button onclick="toggleFullScreen()">
        ğŸ–¥ï¸
        <span class="tooltip">Full Screen</span>
    </button>
    <button onclick="startRecord()" id="startRecordStatus">
        ğŸ“¹
        <span class="tooltip">Start record</span>
    </button>
    <button onclick="stopRecord()" id="stopRecordStatus" style="display: none">
        âºï¸
        <span class="tooltip">Stop record</span>
    </button>
    <button onclick="window.location.href='settings.html'">
        âš™ï¸
        <span class="tooltip">Settings</span>
    </button>
    <button class="toggle-button" onclick="toggleToolbar()">
        ï¸â¬…
        <span class="tooltip">Hidden</span>
    </button>
</div>
</body>
<script src="ch9329.js"></script>
<script>

    let videoElement = document.getElementById("video");
    let containerElement = document.getElementById("container");
    let globalWidth = 1920;
    let globalHeight = 1080;
    let ch;

    function start(devices) {
        let settingsStr = window.localStorage.getItem("settings");
        if (!settingsStr) {
            window.location.href = "settings.html";
            return;
        }

        let settings = JSON.parse(settingsStr);
        let video = settings.video;
        if (!settings.video.deviceId) {
            return;
        }
        let audio = undefined;
        if (settings.audio.deviceId) {
            audio = {
                deviceId: settings.audio.deviceId,
                advanced: [{echoCancellation: false}]
            }
        }

        const constraints = {
            audio: audio,
            video: {deviceId: video.deviceId, width: {exact: globalWidth}, height: {exact: globalHeight}}
        };
        navigator.mediaDevices.getUserMedia(constraints).then(
            stream => {
                videoElement.srcObject = stream;
            }
        ).then(devices).catch(function (e) {
            alert(e.message);
        });

        if (settings.usb.deviceId) {
            navigator.serial.getPorts()
                .then(async function (ports) {
                    if (ports.length === 0) {
                        alert("æœªæ£€æµ‹åˆ°è¾“å…¥è®¾å¤‡,å¦‚æœæœ‰ç›¸å…³è®¾å¤‡.å¯ä»¥åœ¨æˆæƒé¡µé¢è¿›è¡Œæˆæƒ")
                    } else {
                        let port = ports[parseInt(settings.usb.deviceId)]
                        await port.open({baudRate: 9600});
                        let writer = await port.writable.getWriter();
                        ch = new Ch9329(writer);
                        open();
                    }
                })
        }

    }

    function open() {
        videoElement.style.cursor = "none";
        document.addEventListener('keydown', (event) => {
            event.preventDefault()
            ch.keydown(event.code);
        })

        document.addEventListener('keyup', (event) => {
            event.preventDefault();
            ch.keyup(event.code);
        });

        let wheelSet = {};
        document.addEventListener('wheel', function (event) {
            let delta = event.deltaY || event.detail || event.wheelDelta;
            wheelSet["delta"] = delta;
        });
        setInterval(function () {
            if (wheelSet["delta"]) {
                ch.mouseScroll(wheelSet["delta"]);
                wheelSet["delta"] = undefined;
            }
        }, 100)

        videoElement.addEventListener('mousemove', (event) => {
            let screenWidth = videoElement.videoWidth;
            let screenHeight = videoElement.videoHeight;
            let videoWidth = containerElement.offsetWidth;
            let videoHeight = containerElement.offsetHeight;
            ch.mouseMove(screenWidth, screenHeight, videoWidth, videoHeight, event.x, event.y);
        });


        videoElement.addEventListener('mousedown', (event) => {
            event.preventDefault();
            if (event.button === 0) { // æ ‡å‡†å±æ€§æˆ–å…¼å®¹æ€§å±æ€§
                ch.mouseClickLeft();
            }
            if (event.button === 1) { // æ ‡å‡†å±æ€§æˆ–å…¼å®¹æ€§å±æ€§
                ch.mouseClickMiddle();
            }
            if (event.button === 2) { // æ ‡å‡†å±æ€§æˆ–å…¼å®¹æ€§å±æ€§
                ch.mouseClickRight();
            }
        });
        videoElement.addEventListener('contextmenu', (event) => {
            event.preventDefault();
        });
        videoElement.addEventListener('mouseup', (event) => {
            event.preventDefault();
            ch.mouseup();
        });

    }

    document.addEventListener('DOMContentLoaded', () => {
        start()
    });

    // åˆ‡æ¢å·¥å…·æ çš„æ˜¾ç¤ºå’Œéšè—
    function toggleToolbar() {
        const toolbar = document.querySelector('.floating-toolbar');
        toolbar.classList.toggle('hidden');
        const toggleButton = toolbar.querySelector('.toggle-button');
        toggleButton.innerHTML = toolbar.classList.contains('hidden') ? 'ã€‹' : 'â¬…';
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            // è¿›å…¥å…¨å±
            document.documentElement.requestFullscreen();
        } else {
            // é€€å‡ºå…¨å±
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    let mediaRecorder;

    function startRecord() {
        document.querySelector("#startRecordStatus").style.display = "none";
        document.querySelector("#stopRecordStatus").style.display = "block";
        if (mediaRecorder) {
            mediaRecorder.stop();
        }
        const stream = videoElement.srcObject;

        // å°†MediaStreamè½¬æ¢ä¸ºBlobæ•°æ®
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/webm'
        });

        // åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„æ¥ä¿å­˜å½•åˆ¶çš„Blobå¯¹è±¡
        const chunks = [];

        // ç›‘å¬dataavailableäº‹ä»¶æ¥æ”¶é›†Blobæ•°æ®
        mediaRecorder.ondataavailable = event => {
            if (event.data && event.data.size > 0) {
                chunks.push(event.data);
            }
        };

        // ç›‘å¬stopäº‹ä»¶æ¥å¤„ç†å½•åˆ¶å®Œæˆåçš„æ“ä½œ
        mediaRecorder.onstop = () => {
            // åˆ›å»ºä¸€ä¸ªBlob URLæ¥æ’­æ”¾å½•åˆ¶çš„è§†é¢‘
            const blob = new Blob(chunks, {type: 'video/webm'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            let date = new Date();
            a.download = date.getFullYear() + "" + date.getMonth() + "" + date.getDay() + ""
                + date.getHours() + date.getMinutes() + "" + date.getSeconds() + '.webm';
            a.click();
            URL.revokeObjectURL(url);
        };

        // å¼€å§‹å½•åˆ¶
        mediaRecorder.start();
    }

    function stopRecord() {
        if (mediaRecorder) {
            mediaRecorder.stop();
        }

        document.querySelector("#startRecordStatus").style.display = "block";
        document.querySelector("#stopRecordStatus").style.display = "none";
    }

    function paste() {
         navigator.clipboard.readText()
             .then(text=>{
                 for (let lengthKey in text.length) {
                     ch.keydown(lengthKey);
                 }
                 ch.keyup(lengthKey);
             })
    }

</script>
</html>
